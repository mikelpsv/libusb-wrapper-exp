



Original document: https://libusb.sourceforge.io/api-1.0/group__libusb__dev.html 

## Подробное описание

Задокументированная ниже функциональность предназначена для помощи в следующих операциях:

Перечисление USB-устройств, подключенных в настоящее время к системе.
Выбор устройства для работы из вашего программного обеспечения.
Открытие и закрытие выбранного устройства.



## В двух словах...

Пример ниже действительно заставляет вещи казаться более сложными, чем они есть на самом деле. Следующая последовательность вызовов функций подойдет почти для всех сценариев и не требует от вас столь глубокого понимания вопросов управления ресурсами:

```c
// discover devices
libusb_device **list;
libusb_device *found = NULL;
ssize_t cnt = libusb_get_device_list(NULL, &list);
ssize_t i = 0;
int err = 0;
if (cnt < 0)
    error();
for (i = 0; i < cnt; i++) {
    libusb_device *device = list[i];
    if (is_interesting(device)) {
        found = device;
        break;
    }
}
if (found) {
    libusb_device_handle *handle;
    err = libusb_open(found, &handle);
    if (err)
        error();
    // etc
}
libusb_free_device_list(list, 1);
```

Два важных момента:

* Вы попросили `libusb_free_device_list()` освободить ссылки на устройства (2-й параметр)

* Вы открыли устройство перед освобождением списка и удалением ссылок на устройства.

Если вы получили дескриптор, теперь вы можете приступить к выполнению операций ввода-вывода на устройстве.



libusb имеет концепцию USB-устройства, представленного непрозрачным типом `libusb_device`. Устройство представляет собой USB-устройство, которое в настоящее время или ранее было подключено к системе. Используя ссылку на устройство, вы можете получить информацию об устройстве (например, вы можете прочитать данные дескриптора).

Функцию `libusb_get_device_list()` можно использовать для получения списка устройств, подключенных в данный момент к системе. Это называется обнаружением устройств.

Тот факт, что у вас есть ссылка на устройство, не означает, что его можно использовать. Возможно, устройство было отключено от сети, у вас может не быть разрешения на управление таким устройством, или устройство может использовать другая программа или драйвер.

Когда вы нашли устройство, которым хотели бы управлять, вы должны попросить libusb открыть устройство с помощью функции `libusb_open()`. В случае успеха libusb возвращает вам дескриптор устройства (`libusb_device_handle`). Все  операции ввода/вывода тогда работают с дескриптором, а не с исходным указателем устройства.



## Обнаружение устройств и подсчет ссылок

Обнаружение устройств, вызов `libusb_get_device_list()` возвращает актуальный список устройств на момент вызова. Сам список должен быть освобожден, когда вы закончите с ним. libusb также необходимо знать, когда можно освободить содержимое списка — самих устройств.

Для решения этих проблем libusb предоставляет вам два отдельных элемента:

* Функция для освобождения самого списка

* Система подсчета ссылок для устройств внутри

Все новые устройства, представленные функцией `libusb_get_device_list()`, имеют счетчик ссылок, равный 1. Вы можете увеличивать и уменьшать счетчик ссылок, используя `libusb_ref_device()` и `libusb_unref_device()`. Устройство уничтожается, когда его счетчик ссылок достигает 0.

С учетом вышеизложенной информации процесс открытия устройства можно представить следующим образом:

1. Обнаружение устройств с помощью `libusb_get_device_list()`.

2. Выбор устройства, для управления, и вызов `libusb_open()`.

3. Удаление ссылок на все устройства в списке обнаруженных.

4. Освобождение списка обнаруженных устройств.


Порядок важен — вы не должны удалять ссылку на устройство перед попыткой открыть его, потому что это может разрушить ??? устройство.

Для удобства функция `libusb_free_device_list()` включает параметр, позволяющий при необходимости отменить ссылки на все устройства в списке перед освобождением самого списка. Это объединяет шаги 3 и 4 выше.

В качестве детали реализации `libusb_open()` фактически добавляет ссылку на рассматриваемое устройство. Это связано с тем, что устройство остается доступным через дескриптор через `libusb_get_device()`. Ссылка удаляется во время `libusb_close()`.



### Типы

##### libusb_device

Структура, представляющая USB-устройство, обнаруженное в системе.

Это непрозрачный тип, для которого вам предоставляется только указатель, обычно происходящий из `libusb_get_device_list()` или `libusb_hotplug_register_callback()`.

Определенные операции могут выполняться на устройстве, но для выполнения каких-либо операций ввода-вывода вам необходимо сначала получить дескриптор устройства с помощью `libusb_open()`.

Ссылки на устройства подсчитываются с помощью `libusb_ref_device()` и `libusb_unref_device()` и освобождаются, когда счетчик ссылок достигает 0. Новые устройства, представленные `libusb_get_device_list()`, имеют счетчик ссылок, равный 1, и `libusb_free_device_list()` может дополнительно уменьшать счетчик ссылок на всех устройствах в списке. `libusb_open()` добавляет еще одну ссылку, которая позже уничтожается `libusb_close()`.

##### libusb_device_handle

Структура, представляющая дескриптор USB-устройства.

Это непрозрачный тип, для которого вам предоставляется только указатель, обычно исходящий из `libusb_open()`.

Дескриптор устройства используется для выполнения операций ввода-вывода и других операций. Закончив работу с дескриптором устройства, вы должны вызвать `libusb_close()`.



### Перечисления

##### libusb_speed

Коды скорости.

Указывает скорость, с которой работает устройство.

* `LIBUSB_SPEED_UNKNOWN`   ОС не сообщает и не знает скорость устройства.

* `LIBUSB_SPEED_LOW`  Устройство работает на низкой скорости (1.5MBit/s).

* `LIBUSB_SPEED_FULL`  Устройство работает на полной скорости (12MBit/s).

* `LIBUSB_SPEED_HIGH`  Устройство работает на высокой скорости (480MBit/s).

* `LIBUSB_SPEED_SUPER` Устройство работает на суперскорости (5000MBit/s).

* `LIBUSB_SPEED_SUPER_PLUS` Устройство работает на суперскорости плюс  (10000MBit/s).



### Функции

##### libusb_get_device_list

Возвращает список USB-устройств, подключенных в данный момент к системе. Возвращаемое значение этой функции указывает количество устройств в результирующем списке. Список на самом деле на один элемент больше, так как он завершается нулем.

##### libusb_free_device_list

Освобождает список устройств, полученных ранее с помощью `libusb_get_device_list()`.

Если параметр `unref_devices` установлен, счетчик ссылок каждого устройства в списке уменьшается на 1.

##### libusb_get_bus_number

Возвращает номер шины, к которой подключено устройство.

##### libusb_get_port_number

Возвращает номер порта, к которому подключено устройство.

Если операционная система не делает что-то странное или вы не подключаете карты расширения USB в горячем режиме, номер порта, возвращаемый этим вызовом, обычно гарантированно однозначно привязан к физическому порту, а это означает, что разные устройства, подключенные к одному и тому же физическому порту, должны возвращать одно и то же номер порта.

Но кроме этого, нет никакой гарантии, что номер порта, возвращаемый этим вызовом, останется прежним или даже будет соответствовать порядку, в котором порты были пронумерованы производителем HUB/HCD.

##### libusb_get_port_numbers

*Начиная с версии 1.0.16*

Возвращает список всех номеров портов от root для указанного устройства. В параметрах передается указатель на массив и его максимальную длину. Согласно спецификациям USB 3.0, текущий максимальный предел глубины составляет 7.

Возвращает количество заполненных элементов массива или LIBUSB_ERROR_OVERFLOW, если массив слишком мал

##### libusb_get_port_path

Устарело: вместо этого используйте `libusb_get_port_numbers()`.

##### libusb_get_parent

Возвращает родителя для указанного устройства.

Возвращает родительский элемент устройства или NULL, если он недоступен. Вы должны вызвать `libusb_get_device_list()` перед вызовом этой функции и убедиться, что вы обращаетесь только к родителю перед вызовом `libusb_free_device_list()`. Причина в том, что libusb в настоящее время не поддерживает постоянный список экземпляров устройств и, следовательно, может гарантировать только то, что родительские экземпляры полностью созданы в пределах блока `libusb_get_device_list()` - `libusb_free_device_list()`.

##### libusb_get_device_address

Возвращает адрес устройства на шине, к которой оно подключено.

##### libusb_get_device_speed

Возвращает согласованную скорость для устройства в виде кода `libusb_speed`.

##### libusb_get_max_packet_size

Удобная функция для получения значения `wMaxPacketSize` для конкретной конечной точки в конфигурации активного устройства.

Эта функция изначально предназначалась для помощи при настройке изохронных передач, но вместо этого возникла ошибка проектирования. Он просто возвращает значение `wMaxPacketSize` без учета его содержимого. Если вы имеете дело с изохронными передачами, вам, вероятно, понадобится `ibusb_get_max_iso_packet_size()`.

Возвращает значение `wMaxPacketSize` или `LIBUSB_ERROR_NOT_FOUND`, если конечная точка не существует и `LIBUSB_ERROR_OTHER` при другой ошибке

##### libusb_get_max_iso_packet_size

Возвращает максимальный размер пакета, который конкретная конечная точка может отправлять или получать в течение 1 микрофрейма.

Проверяется только активная конфигурация. Расчет основан на поле `wMaxPacketSize` в дескрипторе конечной точки, как описано в разделе 9.6.6 в спецификациях USB 2.0.

При работе с изохронной конечной точкой или точкой прерывания эта функция умножит значение, найденное в битах 0:10, на количество транзакций в микрофрейме (определяется битами 11:12). В противном случае эта функция просто вернет числовое значение, найденное в битах 0:10. Для устройства USB 3.0 он попытается получить дескриптор Endpoint Companion, чтобы вернуть `wBytesPerInterval`.

Эта функция полезна для настройки изохронных передач, например, вы можете передать возвращаемое значение из этой функции в `libusb_set_iso_packet_lengths()`, чтобы установить поле длины каждого изохронного пакета в передаче.

Начиная с версии 1.0.3.

Возвращает максимальный размер пакета, который может быть отправлен/получен на этой конечной точке, или `LIBUSB_ERROR_NOT_FOUND`, если конечная точка не существует, и `LIBUSB_ERROR_OTHER` в случае другой ошибки.

##### libusb_ref_device

Увеличивает счетчик ссылок устройства. Возвращает ссылку на устройство

##### libusb_unref_device

Уменьшает счетчик ссылок устройства. Если операция декремента приводит к тому, что счетчик ссылок достигает нуля, устройство должно быть уничтожено.

##### libusb_wrap_sys_device



libusb_open



libusb_open_device_with_vid_pid



libusb_close



libusb_get_device



libusb_get_configuration



libusb_set_configuration



libusb_claim_interface



libusb_release_interface



libusb_set_interface_alt_setting



libusb_clear_halt



libusb_reset_device



libusb_kernel_driver_active



libusb_detach_kernel_driver



libusb_attach_kernel_driver



libusb_set_auto_detach_kernel_driver
